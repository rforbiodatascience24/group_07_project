---
title: "Proportion of variance explained, plots"
output: html
output-dir: results
execute:
  echo: true
  output: false
---

For the...

```{r}
library("tidyverse")
library("broom")
library("patchwork")
```

Load the data sets.

```{r}
# Set path for processed data directory
processed_data_dir <- file.path("..","data")

# Load the data sets
# mult_reg_data <- read_tsv(file = file.path(processed_data_dir,
#                                            "data.tsv"),
#                           show_col_types = FALSE)
pve_data <- read_tsv(file = file.path(processed_data_dir,
                                         "05.4_dat_pve_species.tsv"),
                     show_col_types = FALSE)
color_palette <- read_tsv(file = file.path(processed_data_dir,
                                         "04_col_pal.tsv"),
                     show_col_types = FALSE)
```

Defined the colors used for the plots

```{r}
attr_color <- color_palette |>
  filter(group == "Attributes") |>
  pull(color)
altern_color <- color_palette |>
  filter(group == "Alternative") |>
  pull(color)
```

Donut plots for significant genes within categories.

```{r}
# Test data
#where donut_data is a df that lists the percentage of all genes that exist in each category of significance

# \\ sample data \\
donut_data_1 <- data.frame(
  category = c("Age+/Sp-", "Age+/Sp+", "Age-/Sp+", "Age-/Sp-"),
  percentage = c(20, 30, 60, 10),
  n = c(100, 400, 700, 50)
)
donut_data_2 <- data.frame(
  category = c("Age+/Sp-", "Age+/Sp+", "Age-/Sp+", "Age-/Sp-"),
  percentage = c(10, 5, 35, 50),
  n = c(50, 25, 400, 700)
)
# \\ sample data \\
```

```{r}
#Human vs chimpanzee
donut_patchwork_plot <- donut_data_1 |>
  ggplot(aes(x = 2, 
             y = n, 
             fill = category)) +
  geom_bar(stat = "identity", 
           width = 1, 
           color = "white") +
  coord_polar(theta = "y") +
  theme_void() +
  xlim(0.5, 2.5) +
  labs(fill = "Attribute Significance", 
       subtitle = "Significance level = 0.05") +
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(size = 8),
    legend.position = "none"
  ) +
  geom_text(aes(label = paste0(percentage, "%")), 
            position = position_stack(vjust = 0.5),
            size = 3, color = "white") +
  scale_fill_manual(values = altern_color)

# Human vs macaque
donut_patchwork_plot2 <- donut_data_2 |>
  ggplot(aes(x = 2, 
             y = n, 
             fill = category)) +
  geom_bar(stat = "identity", 
           width = 1, 
           color = "white") +
  coord_polar(theta = "y") +
  theme_void() +
  xlim(0.5, 2.5) +
  labs(fill = "Attribute Significance") +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "bottom",
    legend.title.position = "top" 
  ) +
  guides(fill = guide_legend(ncol = 2)) + 
  scale_fill_manual(values = altern_color)

combined_plot <- pve_patchwork_plot + 
  (donut_patchwork_plot / donut_patchwork_plot2) +  
  plot_layout(
    ncol = 2,  
    widths = c(1, 1)
  ) + 
  plot_annotation(
    title = "Proportion of Variance Explained and Significant Change in Gene Expressions",
    theme = theme(plot.title = element_text(hjust = 0.5, size = 12))
  )

donut_patchwork_plot
donut_patchwork_plot2
```

Bar plot for pve.

```{r}
pve_patchwork_plot <- pve_data |>
  ggplot(aes(x = Species,
             y = mean_pve,
             fill = attribute)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    x = "Species",
    y = "Proportion of Variance Explained (%)"
    ) +
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "gray80"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = c(0.5, 0.98),  # Positioning the legend below the subtitle
    legend.justification = c(0.5, 1),  # Centers the legend horizontally
    legend.direction = "horizontal",  # Makes the legend horizontal
    legend.title = element_blank(),    # Optional: Removes legend title
    legend.box = "horizontal"          # Optional: Places the legend in a horizontal box
  ) +
  ylim(0, 1) +
  scale_fill_manual(values = attr_color)
```

Combined plot.

```{r}
combined_plot <- pve_patchwork_plot + 
  (donut_patchwork_plot / donut_patchwork_plot2) +  
  plot_layout(
    ncol = 2,  
    widths = c(1, 1)
  ) + 
  plot_annotation(
    title = "Proportion of Variance Explained and Significant Change in Gene Expressions",
    theme = theme(plot.title = element_text(hjust = 0.5, size = 12))
  )

combined_plot
```

Write final plot to *.png* file.

```{r}
ggsave(file = file.path(processed_data_dir,
                        "10_test.png"),
       plot = combined_plot,
       width = 6,
       height = 4,
       dpi = 300)
```
