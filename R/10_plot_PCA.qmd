---
title: "Principle Component Analysis, plots"
output: html
output-dir: results
execute:
  echo: true
  output: false
---

For the principal component analysis (PCA) we want to visualize the data projected into the principal components, along the proportion of variance explained (PVE) for each component.

```{r}
library("tidyverse")
library("broom")
library("patchwork")
library("cowplot")
library("ggtext")

source("15_proj_func.R")
```

We load the data sets.

```{r}
# Set path for processed data directory
processed_data_dir <- file.path("..","data")

# Load the data sets
proj_data <- read_tsv(file = file.path(processed_data_dir,
                                         "05.2_dat_pca_proj.tsv"),
                      show_col_types = FALSE)
pve_data <- read_tsv(file = file.path(processed_data_dir,
                                         "05.3_dat_pve_all.tsv"),
                     show_col_types = FALSE)
color_palette <- read_tsv(file = file.path(processed_data_dir,
                                         "09_col_pal.tsv"),
                     show_col_types = FALSE)
```

```{r}
age_color <- color_palette |>
  filter(group == "Attributes") |>
  slice(1) |>
  pull(color)
sex_color <- color_palette |>
  filter(group == "Attributes") |>
  slice(2) |>
  pull(color)
species_color <- color_palette |>
  filter(group == "Attributes") |>
  slice(3) |>
  pull(color)
```

```{r}
pve_data_prep <- pve_data |>
  group_by(PC) |>
  nest() |>
  mutate(sum_var_expl_pc = map_dbl(.x = data,
                                   .f = ~ .x |>
                                     pull(var_expl_pc)|>
                                     sum())) |>
  unnest(cols = c(data)) |>
  ungroup() |>
  mutate(plt_var_expl = (var_expl_pc / sum_var_expl_pc) * variance_explained) |>
  mutate(attribute = case_when(attribute == "log_age" ~ "Age",
                            attribute == "species_num" ~ "Species",
                            attribute == "sex_num" ~ "Sex")) |>
  mutate(PC = factor(PC,
                     levels = unique(PC)))

```

First we plot the variance explained for each principal component, colored by the PVE by attributes.

```{r}
plot_pc_pve <- pve_data_prep |>
  ggplot(aes(x = PC,
             y = plt_var_expl,
             fill = attribute)) + 
  geom_bar(stat = "identity",
           position = "stack") +
  geom_hline(yintercept = 1,
             linetype = "dashed") +
  labs(
    x = "Principal Component",
    y = "Variance Explained (%)") +
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_blank()) +
  scale_fill_manual(values = color_palette |>
                      filter(group == "Attributes") |>
                      pull(color))

plot_pc_pve
```

The projection data is visualized by plotting the data onto the first two principal components, along with details about age, species, and sex.

```{r}
# Create projection plot of PCs especially influenced by a certain attribute
plot_1_3_proj <- proj_data |>
  pca_proj_plot(principal_component_1 = "PC1",
                principal_component_2 = "PC3")

plot_2_3_proj <- proj_data |>
  pca_proj_plot(principal_component_1 = "PC2",
               principal_component_2 = "PC3")

plot_6_9_proj <- proj_data |>
  pca_proj_plot(principal_component_1 = "PC6",
                principal_component_2 = "PC9")

# Combine projection plots
proj_plots <- plot_grid(
  plot_1_3_proj,
  plot_2_3_proj,
  plot_6_9_proj,
  nrow = 1,
  rel_widths = c(1, 1, 1),
  align = "hv") |>
  ggdraw() +
  theme(plot.background = element_rect(fill = "#F6F6F6",
                                       color = NA),
        plot.margin = margin(0,0,0,0))
```

Combine.

```{r}
# Add projection plots as inset element
combined_plot <- plot_pc_pve +
  inset_element(
    proj_plots,
    left = 0.1,
    right = 1,
    top = 0.9,
    bottom = 0.4) +
  
  plot_annotation(
    title = "PCA reveals clear trends of expression's dependencies on attributes",
    theme = theme(
      plot.title = element_text(size = 16,
                                hjust = 0),
      plot.margin = margin(10, 10, 10, 10))) +
  
  geom_richtext(
    aes(x = -0.01,
        y = 1.05),
    label = paste(
      "The main PVE is by the attributes <span style='color:",
      age_color,
      ";'>age</span> and ",
      "<span style='color:",
      species_color,
      ";'>species</span>..."),
    hjust = 0,
    size = 4,
    label.color = NA,
    fill = NA) +
  
  geom_richtext(
    aes(x = 1.01,
        y = -0.05),
    label = paste(
      "...whereas <span style='color:",
      sex_color,
      ";'>sex</span> is mainly represented in the PCs with lower influence."),
    hjust = 1,
    size = 4,
    label.color = NA,
    fill = NA)



combined_plot
```

Write final plot to *.png* file.

```{r}
ggsave(file = file.path(processed_data_dir,
                        "10_PCA.png"),
       plot = combined_plot,
       width = 12,
       height = 8)
```
