---
title: "MLC Runs"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(dplyr)
library(broom)
```

For every gene, multivariable regression is done to determine whether any of the two factors, age, and species, are significant to change in the expression of that particular gene. Later, the proportion of significant genes will be presented.

Since one of the factors (species) is categorical, the first step is to represent these variables with numeric values, 0 and 1. The code below also extracts the age of all samples.

```{r}
pheno_data_tidy_with_age_species <- pheno_data_tidy |> 
  filter(grepl("Human dorsolateral", title) | grepl("Chimpanzee", title))  |> 
  mutate(species_marker = case_when(
    grepl("Human dorsolateral", title) ~ 0,
    grepl("Chimpanzee", title) ~ 1
  ))
pheno_data_tidy_with_age_species <- pheno_data_tidy_with_age_species |> 
  mutate(age = str_extract(characteristics_ch1, "\\d+\\.?\\d*"))
  
print(pheno_data_tidy_with_age_species)
```

```{r}
pheno_data_tidy_all_species <- pheno_data |> 
  mutate(species_marker = case_when(
    grepl("Human dorsolateral", title) ~ 0,
    grepl("Chimpanzee", title) ~ 1,
    TRUE ~ NA_real_
  ))
pheno_data_tidy_all_species <- pheno_data_tidy_all_species |> 
    mutate(age = as.numeric(str_extract(characteristics_ch1, "\\d+\\.?\\d*")))
print(pheno_data_tidy_all_species)  
```

Creating a new dataframe that now contains all variables of interest

```{r}
expr_factors <- expr_data_tidy_wide |>
  mutate(species = pheno_data_tidy_all_species |> pull(species_marker)) |> 
  mutate(age = pheno_data_tidy_all_species |> pull(age)) 

```

```{r}
expr_factors |> 
  select(tail(3749))
```

Finally, process the data by performing the necesary statistical tests. The code returns a dataframe with information on which genes are predicted with great significance by age or species.

```{r}
expr_factors_stats <- expr_factors |>
  select(-sample) |>  # Exclude the sample ID column
  map_dfr(~ {
    model <- lm(. ~ age + species, data = expr_factors)
    
    # Extract the F-statistic p-value
    f_stat_pvalue <- glance(model)$p.value
    
    # Extract the t-statistic p-values for age and species
    t_stat_pvalues <- tidy(model) |>
      filter(term %in% c("age", "species")) |>
      select(term, p.value) |>
      pivot_wider(names_from = term, values_from = p.value, names_prefix = "t_stat_pvalue_")
    
    # Determine if age and species are significant predictors
    age_significant <- ifelse(t_stat_pvalues$t_stat_pvalue_age < 0.05, "yes", "no")
    species_significant <- ifelse(t_stat_pvalues$t_stat_pvalue_species < 0.05, "yes", "no")
    
    # Combine the results into a single dataframe
    data.frame(
      f_stat_pvalue = f_stat_pvalue,
      t_stat_pvalues,
      age_significant = age_significant,
      species_significant = species_significant
    )
  })

expr_factors_stats
```

Find the fraction of all genes that are significantly predicted by age, species or both.

```{r}
predictor_proportions <- expr_factors_stats |>
  summarize(
    age_prop = mean(age_significant == "yes"),
    species_prop = mean(species_significant == "yes"),
    both_prop = mean(age_significant == "yes" & species_significant == "yes")
  ) |>
  mutate(across(everything(), ~ round(. * 100, 2)))

predictor_proportions
```

Redo all with the augmented data as input.

```{r}
proc_augmented <- pheno_expr_data_joined |> 
  filter(grepl("Human", species) | grepl("Chimpanzee", species))  |> 
  mutate(species_marker = case_when(
    grepl("Human", species) ~ 0,
    grepl("Chimpanzee", species) ~ 1
  ))
```

```{r}
augmented_stats <- proc_augmented |>
  select(-sample) |>  # Exclude columns of data that are of no interest to speed up the process
  select(-species) |> 
  select(-sex) |> 
  map_dfr(~ {
    tryCatch({
      model <- lm(. ~ age + species_marker, data = proc_augmented)
      
      # Extract the F-statistic p-value
      f_stat_pvalue <- glance(model)$p.value
      
      # Extract the t-statistic p-values for age and species
      t_stat_pvalues <- tidy(model) |>
        filter(term %in% c("age", "species_marker")) |>
        select(term, p.value) |>
        pivot_wider(names_from = term, values_from = p.value, names_prefix = "t_stat_pvalue_")
      
      # Determine if age and species are significant predictors
      age_significant <- ifelse(t_stat_pvalues$t_stat_pvalue_age < 0.05, "yes", "no")
      species_significant <- ifelse(t_stat_pvalues$t_stat_pvalue_species_marker < 0.05, "yes", "no")
      
      # Combine the results into a single dataframe
      data.frame(
        f_stat_pvalue = f_stat_pvalue,
        t_stat_pvalues,
        age_significant = age_significant,
        species_significant = species_significant
      )
    }, error = function(e) {
      # Handle any errors that occur during model fitting
      warning(paste("Error in", ., ":", conditionMessage(e)))
      return(NULL)
    })
  })

augmented_stats
```

```{r}
augmented_proportions <- augmented_stats |>
  summarize(
    age_prop = mean(age_significant == "yes"),
    species_prop = mean(species_significant == "yes"),
    both_prop = mean(age_significant == "yes" & species_significant == "yes")
  ) |>
  mutate(across(everything(), ~ round(. * 100, 2)))

augmented_proportions
```
