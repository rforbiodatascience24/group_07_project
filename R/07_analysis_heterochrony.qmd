---
title: "Heterochrony expression test"
output: html
output-dir: results
execute:
  echo: true
  output: false
---

```{r}
library("tidyverse")
library("broom")

source("99_proj_func.R")
```

```{r}
#| output: false

# Set path for processed data directory
processed_data_dir <- file.path("..","data")

# Load cube analyzed dataset
data_cube <- read_tsv(file = file.path(processed_data_dir,
                                      "06.2_dat_cube.tsv"),
                      show_col_types = FALSE)
```

**Estimate Timing Differences**:

-   Introduce an "age-shift" or "expression-shift" between species to align the expression curves.

-   Evaluate whether these shifts significantly improve the model fit (e.g., F-test or likelihood ratio test).

```{r}
#| warning: false

human_chimp_shift <- data_cube |>
  apply_shift_model(original_species = "Human",
                    compared_species = "Chimpanzee")

human_mac_shift <- data_cube |>
  apply_shift_model(original_species = "Human",
                    compared_species = "Macaque")
```

**Classify Heterochronic Genes**:

-   Based on the direction and magnitude of shifts:

    -   **Human Neoteny**: Human expression resembles younger target species.

    -   **Human Acceleration**: Human expression resembles target species.

    -   **Target Species Neoteny/Acceleration**: Reciprocal classification.

```{r}
human_chimp_class <- human_chimp_shift |>
  class_model()

human_mac_class <- human_mac_shift |>
  class_model()
```

Add classifications to shift data frame.

```{r}
human_chimp_table <- human_chimp_class |>
  enframe(name = "classification",
          value = "genes") |>
  unnest(cols = c(genes)) |>
  left_join(human_chimp_shift,
            by = c("genes" = "gene"))

human_mac_table <- human_mac_class |>
  enframe(name = "classification",
          value = "genes") |>
  unnest(cols = c(genes)) |>
  left_join(human_mac_shift,
            by = c("genes" = "gene"))
```

Write results to .*tsv* files.

```{r}
human_chimp_table |>
  dplyr::select(-data) |>
  write_tsv(file = file.path(processed_data_dir,
                             "07.1_hum_chi_hetchron.tsv"))
human_mac_table |>
  dplyr::select(-data) |>
  write_tsv(file = file.path(processed_data_dir,
                             "07.2_hum_mac_hetchron.tsv"))
```
